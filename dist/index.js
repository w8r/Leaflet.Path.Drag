(function(n,u){typeof exports=="object"&&typeof module<"u"?module.exports=u(require("leaflet")):typeof define=="function"&&define.amd?define(["leaflet"],u):(n=typeof globalThis<"u"?globalThis:n||self,n["leaflet-path-drag"]=u(n.L))})(this,function(n){"use strict";n.SVG.include({_resetTransformPath:function(t){t._path.setAttributeNS(null,"transform","")},transformPath:function(t,s){t._path.setAttributeNS(null,"transform","matrix("+s.join(" ")+")")}}),n.SVG.include(n.Browser.vml?{_resetTransformPath:function(t){t._skew&&(t._skew.on=!1,t._path.removeChild(t._skew),t._skew=null)},transformPath:function(t,s){let i=t._skew;i||(i=n.SVG.create("skew"),t._path.appendChild(i),i.style.behavior="url(#default#VML)",t._skew=i);const o=s[0].toFixed(8)+" "+s[1].toFixed(8)+" "+s[2].toFixed(8)+" "+s[3].toFixed(8)+" 0 0",h=Math.floor(s[4]).toFixed()+", "+Math.floor(s[5]).toFixed(),a=this._path.style;let e=parseFloat(a.left),r=parseFloat(a.top),_=parseFloat(a.width),p=parseFloat(a.height);isNaN(e)&&(e=0),isNaN(r)&&(r=0),(isNaN(_)||!_)&&(_=1),(isNaN(p)||!p)&&(p=1);const m=(-e/_-.5).toFixed(8)+" "+(-r/p-.5).toFixed(8);i.on="f",i.matrix=o,i.origin=m,i.offset=h,i.on=!0}}:{});function u(){return!0}n.Canvas.include({_resetTransformPath:function(t){this._containerCopy&&(delete this._containerCopy,t._containsPoint_&&(t._containsPoint=t._containsPoint_,delete t._containsPoint_,this._requestRedraw(t)))},transformPath:function(t,s){let i=this._containerCopy;const o=this._ctx;let h;const a=n.Browser.retina?2:1,e=this._bounds,r=e.getSize(),_=e.min;i||(i=this._containerCopy=document.createElement("canvas"),h=i.getContext("2d"),i.width=a*r.x,i.height=a*r.y,this._removePath(t),this._redraw(),h.translate(a*e.min.x,a*e.min.y),h.drawImage(this._container,0,0),this._initPath(t),t._containsPoint_=t._containsPoint,t._containsPoint=u),o.save(),o.clearRect(_.x,_.y,r.x*a,r.y*a),o.setTransform(1,0,0,1,0,0),o.restore(),o.save(),o.drawImage(this._containerCopy,0,0,r.x,r.y),o.transform.apply(o,s),this._drawing=!0,t._updatePath(),this._drawing=!1,o.restore()}});/**
 * Leaflet vector features drag functionality
 * @author Alexander Milevski <info@w8r.name>
 * @preserve
 */n.Path.include({_transform:function(t){return this._renderer&&(t?this._renderer.transformPath(this,t):(this._renderer._resetTransformPath(this),this._update())),this},_onMouseClick:function(t){this.dragging&&this.dragging.moved()||this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(t)}});const f={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},l={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"};function P(t,s){const i=t.x-s.x,o=t.y-s.y;return Math.sqrt(i*i+o*o)}return n.Handler.PathDrag=n.Handler.extend({statics:{DRAGGING_CLS:"leaflet-path-draggable"},initialize:function(t){this._path=t,this._matrix=null,this._startPoint=null,this._dragStartPoint=null,this._mapDraggingWasEnabled=!1,this._path._dragMoved=!1},addHooks:function(){this._path.on("mousedown",this._onDragStart,this),this._path.options.className=this._path.options.className?this._path.options.className+" "+n.Handler.PathDrag.DRAGGING_CLS:n.Handler.PathDrag.DRAGGING_CLS,this._path._path&&n.DomUtil.addClass(this._path._path,n.Handler.PathDrag.DRAGGING_CLS)},removeHooks:function(){this._path.off("mousedown",this._onDragStart,this),this._path.options.className=this._path.options.className.replace(new RegExp("\\s+"+n.Handler.PathDrag.DRAGGING_CLS),""),this._path._path&&n.DomUtil.removeClass(this._path._path,n.Handler.PathDrag.DRAGGING_CLS)},moved:function(){return this._path._dragMoved},_onDragStart:function(t){const s=t.originalEvent._simulated?"touchstart":t.originalEvent.type;console.log({eventType:s}),this._mapDraggingWasEnabled=!1,this._startPoint=t.containerPoint.clone(),this._dragStartPoint=t.containerPoint.clone(),this._matrix=[1,0,0,1,0,0],n.DomEvent.stop(t.originalEvent),n.DomUtil.addClass(this._path._renderer._container,"leaflet-interactive"),n.DomEvent.on(document,l[s],this._onDrag,this).on(document,f[s],this._onDragEnd,this),this._path._map.dragging.enabled()&&(this._path._map.dragging.disable(),this._mapDraggingWasEnabled=!0),this._path._dragMoved=!1,this._path._popup&&this._path._popup.close(),this._replaceCoordGetters(t)},_onDrag:function(t){n.DomEvent.stop(t);const s=t.touches&&t.touches.length>=1?t.touches[0]:t,i=this._path._map.mouseEventToContainerPoint(s);if(t.type==="touchmove"&&!this._path._dragMoved&&this._dragStartPoint.distanceTo(i)<=this._path._map.options.tapTolerance)return;const o=i.x,h=i.y,a=o-this._startPoint.x,e=h-this._startPoint.y;(a||e)&&(this._path._dragMoved||(this._path._dragMoved=!0,this._path.options.interactive=!1,this._path._map.dragging._draggable._moved=!0,this._path.fire("dragstart",t),this._path.bringToFront()),this._matrix[4]+=a,this._matrix[5]+=e,this._startPoint.x=o,this._startPoint.y=h,this._path.fire("predrag",t),this._path._transform(this._matrix),this._path.fire("drag",t))},_onDragEnd:function(t){const s=this._path._map.mouseEventToContainerPoint(t),i=this.moved();if(i&&(this._transformPoints(this._matrix),this._path._updatePath(),this._path._project(),this._path._transform(null),n.DomEvent.stop(t)),n.DomEvent.off(document,"mousemove touchmove",this._onDrag,this),n.DomEvent.off(document,"mouseup touchend",this._onDragEnd,this),this._restoreCoordGetters(),i){this._path.fire("dragend",{distance:P(this._dragStartPoint,s)});const o=this._path._containsPoint;this._path._containsPoint=n.Util.falseFn,n.Util.requestAnimFrame(function(){this._path._dragMoved=!1,this._path.options.interactive=!0,this._path._containsPoint=o},this)}this._mapDraggingWasEnabled&&this._path._map.dragging.enable()},_transformPoints:function(t,s){const i=this._path,o=L.point(t[4],t[5]),h=i._map.options.crs,a=h.transformation,e=h.scale(i._map.getZoom()),r=h.projection,_=a.untransform(o,e).subtract(a.untransform(n.point(0,0),e)),p=!s;if(i._bounds=new n.LatLngBounds,i._point)s=r.unproject(r.project(i._latlng)._add(_)),p&&(i._latlng=s,i._point._add(o));else if(i._rings||i._parts){const m=i._rings||i._parts;let d=i._latlngs;s=s||d,n.Util.isArray(d[0])||(d=[d],s=[s]);for(let g=0,D=m.length;g<D;g++){s[g]=s[g]||[];for(let c=0,x=m[g].length;c<x;c++){const v=d[g][c];s[g][c]=r.unproject(r.project(v)._add(_)),p&&(i._bounds.extend(d[g][c]),m[g][c]._add(o))}}}return s},_replaceCoordGetters:function(){this._path.getLatLng?(this._path.getLatLng_=this._path.getLatLng,this._path.getLatLng=n.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,{})},this._path)):this._path.getLatLngs&&(this._path.getLatLngs_=this._path.getLatLngs,this._path.getLatLngs=n.Util.bind(function(){return this.dragging._transformPoints(this.dragging._matrix,[])},this._path))},_restoreCoordGetters:function(){this._path.getLatLng_?(this._path.getLatLng=this._path.getLatLng_,delete this._path.getLatLng_):this._path.getLatLngs_&&(this._path.getLatLngs=this._path.getLatLngs_,delete this._path.getLatLngs_)}}),n.Handler.PathDrag.makeDraggable=function(t){return t.dragging=new n.Handler.PathDrag(t),t},n.Path.prototype.makeDraggable=function(){return n.Handler.PathDrag.makeDraggable(this)},n.Path.addInitHook(function(){this.options.draggable?(this.options.interactive=!0,this.dragging?this.dragging.enable():(n.Handler.PathDrag.makeDraggable(this),this.dragging.enable())):this.dragging&&this.dragging.disable()}),n.Handler.PathDrag});
